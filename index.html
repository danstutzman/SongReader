<html>
  <head>
    <title>Annotation interface</title>
    <script type='text/javascript' src='json2.js'></script>
    <script type='text/javascript'
      src='http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js'></script>
  </head>
    <script>
      $(document).ready(function() {
        $.ajax({
          type:'GET',
          url:'/boxes.json',
          dataType: 'text',
          success: function(data) {
            var boxes = JSON.parse(data);
            for (var i = 0; i < boxes.length; i++) {
              var box = boxes[i];
              createBox(global.nextBoxNum,
                box.left, box.top, box.width, box.height);
            }
          },
          error: function(jqXHR, textStatus, errorThrown) {
            console.warn(jqXHR);
            console.warn(textStatus);
            console.warn(errorThrown);
          }
        });
      });

      var global = {
        newBoxMode:false,
        nextBoxNum:0,
        boxes:[]
      }

      function toggleAddMode() {
        if (global.addMode)
          global.addMode = false;
        else {
          global.addMode = true;
          global.deleteMode = false;
        }
        var photo = document.getElementById('photo')
        var corner = document.getElementById('corner');
        if (global.addMode) {
          photo.onmousemove = function() {
            var e = e ? e : window.event;
            corner.style.display = 'block';
            corner.style.left = e.clientX + 'px';
            corner.style.top = e.clientY + 'px';
          }
        }
        else {
          photo.onmousemove = null;
          corner.style.display = 'none';
        }
        return false;
      }

      function toggleDeleteMode() {
        if (global.deleteMode)
          global.deleteMode = false;
        else {
          global.deleteMode = true;
          global.addMode = false;
        }
      }

      function updateBoxJSON() {
        var boxJSON = document.getElementById('box_json');
        var boxes = [];
        for (var i = 0; i < global.nextBoxNum; i++) {
          var boxDiv = document.getElementById('box' + i);
          var box = {
            left: parseInt(boxDiv.style.left),
            top: parseInt(boxDiv.style.top),
            width: parseInt(boxDiv.style.width),
            height: parseInt(boxDiv.style.height)
          };
          boxes.push(box);
        }
        boxJSON.value = JSON.stringify(boxes, 3);
      }

      function createBox(num, left, top, width, height) {
        var box = document.createElement('div');
        box.setAttribute('id', 'box' + num);
        box.setAttribute('style', 'position:absolute;' +
          'left:' + left + 'px' + ';' +
          'top:' + top + 'px' + ';' +
          'width:' + width + 'px;' +
          'height:' + height + 'px;' +
          'border:3px black solid');
        var surroundingDiv = document.getElementById('surrounding_div');
        surroundingDiv.appendChild(box);
        var box = document.getElementById('box' + global.nextBoxNum);
        global.nextBoxNum += 1; // update early so loops include new box
        box.onmousedown = function(e) {
          if (photo.onmousedown) photo.onmousedown(e);
        }
        box.onmousemove = function(e) {
          if (photo.onmousemove) photo.onmousemove(e);
        };
        box.onmouseup = function(e) {
          if (photo.onmouseup) photo.onmouseup(e);
        };
        updateBoxJSON();
      }

      function handleClick(x, y) {
        if (global.addMode) {
          var photo = document.getElementById('photo');
          createBox(global.nextBoxNum, x, y, 50, 50);
          var corner = document.getElementById('corner');
          corner.style.display = 'none';
        }
        else if (global.deleteMode) {
          var foundBox = null;
          for (var i = 0; i < global.nextBoxNum; i++) {
            var box = document.getElementById('box' + i);
            if (box) {
              var x0 = parseInt(box.style.left);
              var y0 = parseInt(box.style.top);
              var x1 = x0 + parseInt(box.style.width);
              var y1 = y0 + parseInt(box.style.height);
              if (box && x >= x0 && y >= y0 && x <= x1 && y <= y1) {
                foundBox = box;
                break;
              }
            }
          }
          if (foundBox) {
            foundBox.style.display = 'none';
            global.deleteMode = false;
          }
        }
      }
      function handleDrag(x, y) {
        if (global.addMode) {
          var box = document.getElementById('box' + (global.nextBoxNum - 1));
          box.style.width  = (x - parseInt(box.style.left)) + 'px';
          box.style.height = (y - parseInt(box.style.top)) + 'px';
        }
      }
      function handleOnMouseDown() {
        var e = e ? e : window.event;
        //if (e.targetTouches)
        //  return; // let the touchstart handler take care of it
        var photo = document.getElementById('photo');
        handleClick(e.clientX, e.clientY);
        photo.onmousemove = function(e) {
          var e = e ? e : window.event;
          handleDrag(e.clientX, e.clientY);
        };
        photo.onmouseup = function(e) {
          if (global.addMode) {
            var photo = document.getElementById('photo');
            photo.onmousemove = null;
            photo.onmouseup = null;
            global.addMode = false;
            updateBoxJSON();
          }
        };
        //var box = document.getElementById('box1');
        //box.onmousemove = photo.onmousemove;
        //box.onmouseup = photo.onmouseup;
        e.preventDefault(); // prevent Chrome's default of dragging the image around
      }
      /*photo.addEventListener('touchstart', function(e) {
        var e = e ? e : window.event;
        //console.log('start ' + e.touches.length);
        if (e.touches.length == 1) {
          var clientX = e.targetTouches[0].pageX;
          var clientY = e.targetTouches[0].pageY;
          handleClick(clientX, clientY);
          e.preventDefault(); // prevent iOS Safari's default of dragging page around
        }
      }, false);
      photo.addEventListener('touchmove', function(e) {
        var e = e ? e : window.event;
        //console.log('move ' + e.touches.length);
        if (e.touches.length == 1) {
          console.log('MOVE 1');
          var clientX = e.targetTouches[0].pageX;
          var clientY = e.targetTouches[0].pageY;
          handleDrag(clientX, clientY);
          e.preventDefault(); // prevent iOS Safari's default of dragging page around
        }
      }, false);*/
    </script>
  <body>
    <div style='position:relative' id='surrounding_div'>
      <div style='float:right;width:200px'>
        <div style='border:1px black solid;border-top:1px gray solid;border-left:1px gray solid;width:100px;height:50px'><a href='#' onClick='return toggleAddMode()'>Add</a></div>
        <div style='border:1px black solid;border-top:1px gray solid;border-left:1px gray solid;width:100px;height:50px'><a href='#' onClick='return toggleDeleteMode()'>Delete</a></div>
        <textarea id='box_json' cols='20' rows='20'></textarea>
      </div>
      <img id='photo' src='/photo.jpeg' onclick='void(0)'/>
      <!--<div id='box1' style='border:1px black solid;position:absolute;left:50px;top:50px;width:100px;height:100px' onclick='void(0)'></div>-->
      <div id='corner' style='border-top:1px black solid;border-left:1px black solid;display:none;position:absolute;width:20px;height:20px'/>
    </div>
    <script>
      document.getElementById('photo').onmousedown = handleOnMouseDown;
    </script>
  </body>
</html>
