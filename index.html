<html>
  <head>
    <title>Annotation interface</title>
  </head>
    <script>
      var global = {
        newBoxMode:false,
        nextBoxNum:0,
        boxes:[]
      }

      function toggleAddMode() {
        if (global.addMode)
          global.addMode = false;
        else {
          global.addMode = true;
          global.deleteMode = false;
        }
        var photo = document.getElementById('photo')
        var corner = document.getElementById('corner');
        if (global.addMode) {
          photo.onmousemove = function() {
            var e = e ? e : window.event;
            corner.style.display = 'block';
            corner.style.left = e.clientX + 'px';
            corner.style.top = e.clientY + 'px';
          }
        }
        else {
          photo.onmousemove = null;
          corner.style.display = 'none';
        }
        return false;
      }

      function toggleDeleteMode() {
        if (global.deleteMode)
          global.deleteMode = false;
        else {
          global.deleteMode = true;
          global.addMode = false;
        }
      }

      function handleClick(x, y) {
        if (global.addMode) {
          var photo = document.getElementById('photo');
          var box = document.createElement('div');
          box.setAttribute('id', 'box' + global.nextBoxNum);
          box.setAttribute('style', 'position:absolute;' +
            'left:' + x + 'px' + ';' +
            'top:' + y + 'px' + ';' +
            'width:50px;height:50px;border:1px black solid');
          var surroundingDiv = document.getElementById('surrounding_div');
          surroundingDiv.appendChild(box);
          box = document.getElementById('box' + global.nextBoxNum);
          box.onmousedown = function(e) { photo.onmousedown(e); }
          box.onmousemove = function(e) { photo.onmousemove(e); };
          box.onmouseup = function(e) { photo.onmouseup(e); };

          var corner = document.getElementById('corner');
          corner.style.display = 'none';

          global.nextBoxNum += 1;
        }
        else if (global.deleteMode) {
          var foundBox = null;
          for (var i = 0; i < global.nextBoxNum; i++) {
            var box = document.getElementById('box' + i);
            if (box) {
              var x0 = parseInt(box.style.left);
              var y0 = parseInt(box.style.top);
              var x1 = x0 + parseInt(box.style.width);
              var y1 = y0 + parseInt(box.style.height);
              if (box && x >= x0 && y >= y0 && x <= x1 && y <= y1) {
                foundBox = box;
                break;
              }
            }
          }
          if (foundBox) {
            foundBox.style.display = 'none';
            global.deleteMode = false;
          }
        }
      }
      function handleDrag(x, y) {
        if (global.addMode) {
          var box = document.getElementById('box' + (global.nextBoxNum - 1));
          box.style.width  = (x - parseInt(box.style.left)) + 'px';
          box.style.height = (y - parseInt(box.style.top)) + 'px';
        }
      }
      function handleOnMouseDown() {
        var e = e ? e : window.event;
        //if (e.targetTouches)
        //  return; // let the touchstart handler take care of it
        var photo = document.getElementById('photo');
        handleClick(e.clientX, e.clientY);
        photo.onmousemove = function(e) {
          var e = e ? e : window.event;
          handleDrag(e.clientX, e.clientY);
        };
        photo.onmouseup = function(e) {
          if (global.addMode) {
            var photo = document.getElementById('photo');
            photo.onmousemove = null;
            photo.onmouseup = null;
            var box = document.getElementById('box' + (global.nextBoxNum - 1));
            box.onmousemove = null;
            box.onmouseup = null;
            global.addMode = false;
          }
        };
        //var box = document.getElementById('box1');
        //box.onmousemove = photo.onmousemove;
        //box.onmouseup = photo.onmouseup;
        e.preventDefault(); // prevent Chrome's default of dragging the image around
      }
      /*photo.addEventListener('touchstart', function(e) {
        var e = e ? e : window.event;
        //console.log('start ' + e.touches.length);
        if (e.touches.length == 1) {
          var clientX = e.targetTouches[0].pageX;
          var clientY = e.targetTouches[0].pageY;
          handleClick(clientX, clientY);
          e.preventDefault(); // prevent iOS Safari's default of dragging page around
        }
      }, false);
      photo.addEventListener('touchmove', function(e) {
        var e = e ? e : window.event;
        //console.log('move ' + e.touches.length);
        if (e.touches.length == 1) {
          console.log('MOVE 1');
          var clientX = e.targetTouches[0].pageX;
          var clientY = e.targetTouches[0].pageY;
          handleDrag(clientX, clientY);
          e.preventDefault(); // prevent iOS Safari's default of dragging page around
        }
      }, false);*/
    </script>
  <body>
    <div style='position:relative' id='surrounding_div'>
      <div style='float:right;border:1px black solid;border-top:1px gray solid;border-left:1px gray solid;width:100px;height:50px'><a href='#' onClick='return toggleAddMode()'>Add</a></div>
      <div style='float:right;border:1px black solid;border-top:1px gray solid;border-left:1px gray solid;width:100px;height:50px'><a href='#' onClick='return toggleDeleteMode()'>Delete</a></div>
      <img id='photo' src='/photo.jpeg' onclick='void(0)'/>
      <!--<div id='box1' style='border:1px black solid;position:absolute;left:50px;top:50px;width:100px;height:100px' onclick='void(0)'></div>-->
      <div id='corner' style='border-top:1px black solid;border-left:1px black solid;display:none;position:absolute;width:20px;height:20px'/>
    </div>
    <script>
      document.getElementById('photo').onmousedown = handleOnMouseDown;
    </script>
  </body>
</html>
